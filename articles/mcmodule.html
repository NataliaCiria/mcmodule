<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>mcmodule ‚Ä¢ mcmodule</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="mcmodule">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mcmodule</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/mcmodule.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/intro.html">Introduction</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NataliaCiria/mcmodule/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>mcmodule</h1>
            <h3 data-toc-skip class="subtitle">Modular Monte-Carlo Risk
Analysis</h3>
                        <h4 data-toc-skip class="author">Natalia
Ciria</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NataliaCiria/mcmodule/blob/main/vignettes/mcmodule.Rmd" class="external-link"><code>vignettes/mcmodule.Rmd</code></a></small>
      <div class="d-none name"><code>mcmodule.Rmd</code></div>
    </div>

    
    
<blockquote>
<p><em>Work in progress!</em> üèó</p>
</blockquote>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This guide presents a flexible approach for building risk assessment
models with Monte Carlo simulations in R. The framework is
<strong>multivariate</strong>, allowing simultaneous analysis of
multiple variates (different categories or groups), and
<strong>modular,</strong> breaking complex systems into manageable
components.</p>
<p>The <code>mc2d</code> R package <span class="citation">(<a href="#ref-mc2d">Pouillot and Delignette-Muller 2010</a>)</span>
provides tools to build and analyse models involving multiple variables
and uncertainties based on Monte Carlo simulations. However, these tools
are limited when handling multiple variates, and complex models can be
difficult to analyse and interpret. The <code>mcmodule</code> package
builds on the R package mc2d to enhance model flexibility. This new
package provides:</p>
<ol style="list-style-type: decimal">
<li>Tools to add metadata to model elements for better traceability and
debugging</li>
<li>Tools to handle complex multivariate variables</li>
<li>A framework to break down Monte Carlo models into smaller, reusable
components (modules) that can be analysed independently before
integration</li>
</ol>
</div>
<div class="section level2">
<h2 id="multivariate-monte-carlo-simulations">Multivariate Monte-Carlo simulations<a class="anchor" aria-label="anchor" href="#multivariate-monte-carlo-simulations"></a>
</h2>
<div class="line-block"><em>This section draws from the <a href="https://cran.r-project.org/package=mc2d" class="external-link">mc2d</a> package
vignette, with adaptations for modular Monte Carlo
simulations.</em></div>
<p>Quantitative risk analysis is the numerical assessment of risk to
facilitate decision making in the face of uncertainty. Monte Carlo
simulation is a technique used to model and analyse uncertainty <span class="citation">(<a href="#ref-Vose2008">Vose 2008</a>)</span>. In
typical two-dimensional Monte Carlo simulation, one dimension represents
variability and the other represents uncertainty. However, in this
framework, we take a different approach where:</p>
<ul>
<li><p>We combine <strong>variability</strong> and
<strong>uncertainty</strong> into one dimension
(<strong><em>u</em></strong>)</p></li>
<li><p>We use <strong>variates</strong> (representing different groups
or categories) in the other dimension
(<strong><em>i</em></strong>)</p></li>
</ul>
<p>This approach enables us to track multiple values across groups
simultaneously using variates and to handle cases where values must be
aggregated by animal movements, farms, or other grouped entities.
Although it would be technically possible to separate variability and
uncertainty, the exponential increase in computational and programming
requirements would make it impractical in models of this size.</p>
<p>In this framework, an mcnode is an array of <strong>dimensions
(<em>u</em> √ó 1 √ó <em>i</em>)</strong>, where u is the dimension of
variability and uncertainty combined, and i is the number of variates.
As most of the input parameters are uncertain, we will use the term
‚Äúuncertainty dimension‚Äù throughout this document to refer to the
combined dimension of variability and uncertainty.</p>
<div class="float">
<img src="images/mcmodule_mcnode_definition.png" style="display: block; margin: 1em auto;width:40.0%" fig-align="center" alt="Structure of an mcnode containing u uncertainty iterations and i variates."><div class="figcaption">Structure of an mcnode containing u uncertainty
iterations and i variates.</div>
</div>
<p>For example, if we are buying a number of cows and heifers from a
specific region, a mcnode for herd prevalence would have:</p>
<ul>
<li><p>Multiple variates (rows), each representing a specific animal
category-disease combination. The variables that define and distinguish
these variates are called <strong>keys</strong>.</p></li>
<li><p>Probability values generated through a PERT distribution (rpert),
using minimum, mode, and maximum parameters across <em>u</em> iterations
(columns) to model the uncertainty in these estimates.</p></li>
</ul>
<div class="float">
<img src="images/mcmodule_mcnode_example.png" style="display: block; margin: 1em auto;width:85.0%" fig-align="center" alt="An mcnode representing herd prevalence of three pathogens, tuberculosis (TB), infectious bovine rhinotracheitis (IBR), and bovine viral diarrhea (BVD), and two animal categories (cows and heifers). The herd prevalence is the same for both animal categories, but values differ due to the stochastic nature of random sampling from the PERT distribution."><div class="figcaption">An mcnode representing herd prevalence of three
pathogens, tuberculosis (TB), infectious bovine rhinotracheitis (IBR),
and bovine viral diarrhea (BVD), and two animal categories (cows and
heifers). The herd prevalence is the same for both animal categories,
but values differ due to the stochastic nature of random sampling from
the PERT distribution.</div>
</div>
<div class="section level3">
<h3 id="scenarios">Scenarios<a class="anchor" aria-label="anchor" href="#scenarios"></a>
</h3>
<p>This framework enables the creation and comparison of scenarios. For
comparisons, you need a baseline scenario (scenario ‚Äú0‚Äù) and one or more
alternative scenarios. Variates within a scenario are called ‚Äúgroups.‚Äù
While not every scenario needs to contain all baseline groups, any
groups present in alternative scenarios must exist in the baseline.</p>
<p>The scenario id, group id, and row number are the three mcnode
properties that enable row matching and row aggregation operations.</p>
<div class="float">
<img src="images/mcmodule_mcnode_scenarios.png" style="display: block; margin: 1em auto;width:70.0%" fig-align="center" alt="An mcnode representing the probability of a farm being infected in a baseline scenario (‚Äú0‚Äù, in blue) and in a what-if scenario where there is a control plan implemented (‚Äúa‚Äù, in green)."><div class="figcaption">An mcnode representing the probability of a farm
being infected in a baseline scenario (‚Äú0‚Äù, in blue) and in a what-if
scenario where there is a control plan implemented (‚Äúa‚Äù, in
green).</div>
</div>
</div>
<div class="section level3">
<h3 id="multivariate-nodes-operations">Multivariate nodes operations<a class="anchor" aria-label="anchor" href="#multivariate-nodes-operations"></a>
</h3>
<div class="section level4">
<h4 id="sec-element-wise-operations">Element-wise operations<a class="anchor" aria-label="anchor" href="#sec-element-wise-operations"></a>
</h4>
<p>Most operations in this model are element-wise, meaning each
calculation occurs independently on matching elements across nodes.
These operations preserve node dimensions while applying functions (such
as multiplication or addition) to corresponding elements, allowing
uncertainties and variates to propagate through the calculations.</p>
<p><img src="images/mcmodule_mcnode_element-wise_operation.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
<div class="section level4">
<h4 id="sec-row-matching">Row matching<a class="anchor" aria-label="anchor" href="#sec-row-matching"></a>
</h4>
<p>Row matching operations align nodes to ensure they have compatible
dimensions and properly matched rows for element-wise calculations. This
is especially important when working with nodes containing different
scenarios. The matching process may require reordering, duplicating, or
adding rows to either or both nodes.</p>
<p>Row matching between nodes is needed in the following cases and their
combinations:</p>
<div class="section level5">
<h5 id="group-matching">Group matching<a class="anchor" aria-label="anchor" href="#group-matching"></a>
</h5>
<p>Nodes with same scenarios/dimensions but different group order</p>
<ol style="list-style-type: decimal">
<li>Check if keys that define groups are in a different order</li>
</ol>
<p><img src="images/mcmodule_group_match_1.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="2" style="list-style-type: decimal">
<li>Assign common group ids, based on keys</li>
</ol>
<p><img src="images/mcmodule_group_match_2.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="3" style="list-style-type: decimal">
<li>Reorder rows to align group ids. This is similar to dplyr
<code>left_join</code>
</li>
</ol>
<p><img src="images/mcmodule_group_match_3.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
<div class="section level5">
<h5 id="scenario-matching">Scenario matching<a class="anchor" aria-label="anchor" href="#scenario-matching"></a>
</h5>
<p>Nodes with same groups but different scenarios. The general rule for
these operations is that when no scenario is specified, it is assumed
that a variable takes the values from the baseline scenario.</p>
<ol style="list-style-type: decimal">
<li>Check if scenarios are different</li>
</ol>
<p><img src="images/mcmodule_scenario_match_1.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="2" style="list-style-type: decimal">
<li>For missing scenarios, duplicate the baseline scenario (scenario
‚Äú0‚Äù)</li>
</ol>
<p><img src="images/mcmodule_scenario_match_2.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="3" style="list-style-type: decimal">
<li>When nodes matched by scenario are used in an element-wise
operation, the resulting node will contain all scenarios from both input
nodes. This is conceptually similar to a dplyr <code>full_join</code>,
except that any unmatched rows use values from the baseline
scenario.</li>
</ol>
<p><img src="images/mcmodule_scenario_match_3.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
<div class="section level5">
<h5 id="null-matching">Null matching<a class="anchor" aria-label="anchor" href="#null-matching"></a>
</h5>
<p>When nodes contain different scenarios and groups, some groups may be
missing from certain nodes. These missing groups (called ‚Äúnull‚Äù
variates) are assigned a probability of 0. This operation typically
complements scenario matching.</p>
<ol style="list-style-type: decimal">
<li>Check for missing groups</li>
</ol>
<p><img src="images/mcmodule_null_matching_1.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="2" style="list-style-type: decimal">
<li>Add null variates with probability 0 for any missing groups (and
apply scenario matching)</li>
</ol>
<p><img src="images/mcmodule_null_matching_2.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol style="list-style-type: decimal">
<li>When nodes are matched by scenario in an element-wise operation, the
resulting node will contain all groups from both input nodes</li>
</ol>
<p><img src="images/mcmodule_null_matching_3.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
</div>
<div class="section level4">
<h4 id="combined-probabilities">Combined probabilities<a class="anchor" aria-label="anchor" href="#combined-probabilities"></a>
</h4>
<p>A special type of element-wise operation that automatically deals
with row matching. Combines probabilities of multiple events assuming
independence, using the formula:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>‚à™</mo><mi>B</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn><mo>‚àí</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>B</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex"> P(A \cup B) = 1 - (1-P(A))(1-P(B))</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="sec-row-aggregation">Row aggregation<a class="anchor" aria-label="anchor" href="#sec-row-aggregation"></a>
</h4>
<p>Row aggregation operations combine values across multiple rows
(variates) in an mcnode using specific criteria. These operations
calculate overall probabilities or sum quantities across groups.</p>
<div class="section level5">
<h5 id="probabilities">Probabilities<a class="anchor" aria-label="anchor" href="#probabilities"></a>
</h5>
<p>Some events can occur independently across multiple variates of the
same node. For example, a disease might be present in animals from
different regions or farms. To calculate the probability of an
<strong>event occurring in at least one variate</strong> within a
subset, we first group the data by aggregation keys (<em>agg_keys</em>).
Then, for each subset, we use the standard probability formula for
independent trials to find the probability of the event occurring in at
least one variate.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>_</mi><mrow><mi>a</mi><mi>g</mi><mi>g</mi></mrow><mo>=</mo><mn>1</mn><mo>‚àí</mo><munder><mo>‚àè</mo><mrow><mi>p</mi><mo>‚äÜ</mo><mi>S</mi></mrow></munder><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p\_{agg}=1-\prod_{p\subseteq S}(1-p)
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><em>S</em> represents the subset of variates included in the
aggregation</p></li>
<li><p><em>p</em> represents the probability of an event
occurring</p></li>
<li><p><em>p_agg</em> represents the probability of occurrence in at
least one variate of S</p></li>
</ul>
<div class="float">
<img src="images/mcmodule_row_aggregation_p.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center" alt="Row aggregation by pathogen. The calculation is performed element-wise across subset variates to maintain uncertainty propagation."><div class="figcaption">Row aggregation by pathogen. The calculation is
performed element-wise across subset variates to maintain uncertainty
propagation.</div>
</div>
<p>If scenarios are being simulated, scenario id must always be included
as an aggregation key, as probabilities are not calculated across
different what-if scenarios.</p>
<p>You can also keep all variariates, with their corresponding
aggregated values, to ensure dimensions compatibility in further
calculations.</p>
<div class="float">
<img src="images/mcmodule_keep_variates.png" style="display: block; margin: 1em auto;width:80.0%" fig-align="center" alt="Default row aggregation and row aggregation keeping all variates"><div class="figcaption">Default row aggregation and row aggregation
keeping all variates</div>
</div>
</div>
<div class="section level5">
<h5 id="quantities">Quantities<a class="anchor" aria-label="anchor" href="#quantities"></a>
</h5>
<p>When working with quantities (such as number of animals or farms), we
calculate totals by summing values across variates within each
subset.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>_</mi><mrow><mi>a</mi><mi>g</mi><mi>g</mi></mrow><mo>=</mo><munder><mo>‚àë</mo><mrow><mi>n</mi><mo>‚äÜ</mo><mi>S</mi></mrow></munder><mi>n</mi></mrow><annotation encoding="application/x-tex"> n\_{agg}=\sum_{n\subseteq S} n </annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><em>S</em> represents the subset of variates included in the
aggregation</p></li>
<li><p><em>n</em> represents the quantity value</p></li>
<li><p><em>n_agg</em> represents the sum of quantities across all
variates in <em>S</em></p></li>
</ul>
</div>
</div>
<div class="section level4">
<h4 id="trials">Trials<a class="anchor" aria-label="anchor" href="#trials"></a>
</h4>
<p>In this framework, nodes typically represent the probability of
<strong>success for a</strong> <strong>single trial with a binary
outcome</strong> (success/failure). A trial is one instance where an
event might occur, for example, an animal, farm, batch, animal movement,
or farm visit. Each trial has two possible outcomes, such as whether an
animal is infected or not, or whether a test is positive or negative. In
<strong>single-level</strong> trials, all trials are independent and
have the same probability of success<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;In this context, a ‚Äúsuccess‚Äù refers to the occurrence of
an event of interest, which may actually represent an undesirable
outcome such as the presence of a disease or a positive test result for
a pathogen.&lt;/p&gt;"><sup>1</sup></a>.</p>
<p>Some probability processes follow a hierarchical structure where
events occur at different levels. For example, when animals are
purchased from multiple farms, we must consider both the probability of
a farm being infected and the probability of an individual animal within
that farm being infected. This means infection probabilities for animals
from the same farm are not independent. In <strong>multilevel</strong>
trials, trials are organized into subsets, with each subset having its
own selection probability. A subset represents a group sharing specific
characteristics, for example, animals from the same farm or with the
same health status.</p>
<p>Most of the following probability processes and calculations are
based on Chapter 5 of the <em>Handbook on Import Risk Analysis for
Animals and Animal Products Volume 2. Quantitative risk assessment</em>
<span class="citation">(<a href="#ref-Murray2004">Murray
2004</a>)</span>.</p>
<div class="section level5">
<h5 id="single-level-trials">Single-level trials<a class="anchor" aria-label="anchor" href="#single-level-trials"></a>
</h5>
<p>In single-level trials, each trial is independent with the same
probability of success
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">trial\_p</annotation></semantics></math>).
For a set of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">trials\_n</annotation></semantics></math>
trials, the probability of at least one success is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex"> set\_p= 1-(1-trial\_p)^{trials\_n} </annotation></semantics></math></p>
<p>In <code>imports_mcmodule</code>, we have the probability that an
infected animal from an infected farm goes undetected
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>_</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">no\_detect\_a</annotation></semantics></math>).
When all animals (in a variate) have the same probability, we can use
the total number of animals selected per farm
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">animals\_n</annotation></semantics></math>)
as the number of trials (<code>trials_n</code>) to determine the
probability that at least one infected animal from one farm is not
detected
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>_</mi><mi>s</mi><mi>e</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">no\_detect\_set</annotation></semantics></math>).
Note that while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">animals\_n</annotation></semantics></math>
isn‚Äôt defined as an mcnode in <code>imports_mcmodule</code> (not used in
<code>imports_mcmodule$model_exp</code>), it can be automatically
generated in <code><a href="../reference/trial_totals.html">trial_totals()</a></code> because it‚Äôs included in
<code>imports_mctable</code> and the required data exists in
<code>imports_mcmodule$data</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Single-level trial</span></span>
<span><span class="va">imports_mcmodule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_totals.html">trial_totals</a></span><span class="op">(</span></span>
<span>  mcmodule <span class="op">=</span> <span class="va">imports_mcmodule</span>,</span>
<span>  mc_names <span class="op">=</span> <span class="st">"no_detect_a"</span>, <span class="co"># trial_p</span></span>
<span>  trials_n <span class="op">=</span> <span class="st">"animals_n"</span>,</span>
<span>  mctable <span class="op">=</span> <span class="va">imports_mctable</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Probability that at least one infected animal from an infected farm is not detected</span></span>
<span><span class="fu"><a href="../reference/mc_summary.html">mc_summary</a></span><span class="op">(</span><span class="va">imports_mcmodule</span>,<span class="st">"no_detect_a_set"</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;   pathogen origin      mean           sd       Min      2.5%       25%</span></span>
<span><span class="co">#&gt; 1        a   nord 0.9999344 7.271373e-05 0.9994190 0.9997340 0.9999148</span></span>
<span><span class="co">#&gt; 2        a  south 0.9999945 9.174980e-06 0.9998817 0.9999651 0.9999936</span></span>
<span><span class="co">#&gt; 3        a   east 1.0000000 3.759259e-10 1.0000000 1.0000000 1.0000000</span></span>
<span><span class="co">#&gt; 4        b   nord 0.9994337 7.901747e-04 0.9939744 0.9970818 0.9993747</span></span>
<span><span class="co">#&gt; 5        b  south 1.0000000 4.055315e-14 1.0000000 1.0000000 1.0000000</span></span>
<span><span class="co">#&gt; 6        b   east 1.0000000 0.000000e+00 1.0000000 1.0000000 1.0000000</span></span>
<span><span class="co">#&gt;         50%       75%     97.5%       Max  nsv Na's</span></span>
<span><span class="co">#&gt; 1 0.9999601 0.9999825 0.9999952 0.9999982 1001    0</span></span>
<span><span class="co">#&gt; 2 0.9999979 0.9999993 0.9999999 1.0000000 1001    0</span></span>
<span><span class="co">#&gt; 3 1.0000000 1.0000000 1.0000000 1.0000000 1001    0</span></span>
<span><span class="co">#&gt; 4 0.9997226 0.9998992 0.9999833 0.9999951 1001    0</span></span>
<span><span class="co">#&gt; 5 1.0000000 1.0000000 1.0000000 1.0000000 1001    0</span></span>
<span><span class="co">#&gt; 6 1.0000000 1.0000000 1.0000000 1.0000000 1001    0</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="multilevel-trials">Multilevel trials<a class="anchor" aria-label="anchor" href="#multilevel-trials"></a>
</h5>
<p><strong>Simple multilevel</strong></p>
<p>In multilevel trials, we account for hierarchical structures where
trials are organized into subsets. For example, when considering animals
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">trials\_n</annotation></semantics></math>)
from different farms
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">subset\_n</annotation></semantics></math>),
we must account for both the farm‚Äôs selection probability
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">subset\_p</annotation></semantics></math>)
and the individual animal‚Äôs probability of success
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">trial\_p</annotation></semantics></math>).</p>
<p>The probability of at least one success in this hierarchical
structure is given by:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>‚ãÖ</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>n</mi></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex"> set\_p= 1-(1-subset\_p \cdot (1-(1-trial\_p)^{trial\_n}))^{subset\_n}  </annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><em>trials_p</em> represents the probability of a trial in a
subset being a success</p></li>
<li><p><em>trials_n</em> represents the number of trials in
subset</p></li>
<li><p><em>subset_p</em> represents the probability of a subset being
selected</p></li>
<li><p><em>subset_n</em> represents the number of subsets</p></li>
<li><p><em>set_p</em> represents the probability of a at least one trial
of at least one subsetbeing a success</p></li>
</ul>
<p>When considering animals (<code>trials_n</code>) from different farms
(<code>subset_n</code>, we must account for both the farm‚Äôs probability
of being infected (<code>subsets_p</code>) and the individual animal‚Äôs
probability of being infected (<code>trial_p</code>).</p>
<p><img src="images/mcmodule_multilevel_trial_drawing.png"></p>
<p><img src="images/mcmodule_multilevel_trial_diagram.png"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simple multilevel trial</span></span>
<span><span class="va">imports_mcmodule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_totals.html">trial_totals</a></span><span class="op">(</span></span>
<span>  mcmodule <span class="op">=</span> <span class="va">imports_mcmodule</span>,</span>
<span>  mc_names <span class="op">=</span> <span class="st">"no_detect_a"</span>, <span class="co"># trial_p</span></span>
<span>  trials_n <span class="op">=</span> <span class="st">"animals_n"</span>,</span>
<span>  subsets_n <span class="op">=</span> <span class="st">"farms_n"</span>,</span>
<span>  subsets_p <span class="op">=</span> <span class="st">"h_prev"</span>,</span>
<span>  mctable <span class="op">=</span> <span class="va">imports_mctable</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Probability that at least one infected animal from at least one farm is not detected</span></span>
<span><span class="fu"><a href="../reference/mc_summary.html">mc_summary</a></span><span class="op">(</span><span class="va">imports_mcmodule</span>,<span class="st">"no_detect_a_set"</span>, digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;   pathogen origin mean     sd  Min 2.5%  25%  50%  75% 97.5%  Max  nsv Na's</span></span>
<span><span class="co">#&gt; 1        a   nord 0.38 0.0200 0.34 0.34 0.36 0.38 0.39  0.41 0.41 1001    0</span></span>
<span><span class="co">#&gt; 2        a  south 0.30 0.0600 0.18 0.19 0.24 0.30 0.36  0.40 0.40 1001    0</span></span>
<span><span class="co">#&gt; 3        a   east 0.60 0.0400 0.52 0.53 0.57 0.60 0.64  0.67 0.68 1001    0</span></span>
<span><span class="co">#&gt; 4        b   nord 0.99 0.0081 0.97 0.97 0.98 0.99 0.99  1.00 1.00 1001    0</span></span>
<span><span class="co">#&gt; 5        b  south 0.96 0.0081 0.94 0.94 0.95 0.96 0.97  0.97 0.97 1001    0</span></span>
<span><span class="co">#&gt; 6        b   east 0.97 0.0200 0.92 0.92 0.95 0.97 0.98  0.99 0.99 1001    0</span></span></code></pre></div>
<p><strong>Multiple group multilevel trials</strong></p>
<p>In multiple group multilevel trials, several variates (groups) can
belong to the same subset. For example, when selecting animals of
different categories (cow, calf, heifer, bull) from the same farm, their
infection probabilities are not independent. You should include
aggregation keys for groups that are not independent to calculate their
trial probabilities, for example, aggregating variates for different
animal categories by farm. For this calculation, the subset_p and
subset_n values must be identical across all variates being
aggregated.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mi>_</mi><mi>a</mi><mi>g</mi><mi>g</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><munder><mo>‚àè</mo><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo>‚äÜ</mo><mi>S</mi></mrow></munder><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">
trial\_p\_agg=1-\prod_{trial\_p\subseteq S}(1-trial\_p)^{trial\_n}
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mi>_</mi><mi>a</mi><mi>g</mi><mi>g</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>‚ãÖ</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mi>_</mi><mi>a</mi><mi>g</mi><mi>g</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex"> set\_p\_agg = 1-(1-subset\_p \cdot trial\_p\_agg)^{subset\_n}  </annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p>S represents the variates included in the aggregation</p></li>
<li><p><em>trials_p</em> represents the probability of success of a
trial in a subset</p></li>
<li><p><em>trials_n</em> represents the number of trials in
subset</p></li>
<li><p><em>trials_p</em> <em>_agg</em> represents the probability of
success of at least one variate in at least one of the aggregated
variates</p></li>
<li><p><em>subset_p</em> represents the probability of a subset being
selected</p></li>
<li><p><em>subset_n</em> represents the number of subsets</p></li>
<li><p><em>set_p_agg</em> represents the probability of success of a at
least one trial in at least one of the aggregated variates in at least
one subset</p></li>
</ul>
<p>As with row aggregation, you can keep all variates to maintain
dimensions compatibility in further calculations.</p>
<p><img src="images/mcmodule_multilevel_trial_drawing_groups.png"></p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="model-elements">Model elements<a class="anchor" aria-label="anchor" href="#model-elements"></a>
</h2>
<div class="section level3">
<h3 id="expressions">Expressions<a class="anchor" aria-label="anchor" href="#expressions"></a>
</h3>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
</div>
<div class="section level3">
<h3 id="nodes">Nodes<a class="anchor" aria-label="anchor" href="#nodes"></a>
</h3>
<div class="section level4">
<h4 id="input-nodes">Input nodes<a class="anchor" aria-label="anchor" href="#input-nodes"></a>
</h4>
</div>
<div class="section level4">
<h4 id="nodes-metadata">Nodes metadata<a class="anchor" aria-label="anchor" href="#nodes-metadata"></a>
</h4>
</div>
</div>
<div class="section level3">
<h3 id="modules">Modules<a class="anchor" aria-label="anchor" href="#modules"></a>
</h3>
<div class="section level4">
<h4 id="estructure">Estructure<a class="anchor" aria-label="anchor" href="#estructure"></a>
</h4>
</div>
<div class="section level4">
<h4 class="unnumbered" id="modules-metadata">Modules metadata<a class="anchor" aria-label="anchor" href="#modules-metadata"></a>
</h4>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Murray2004" class="csl-entry">
Murray, Noel. 2004. <em>Handbook on <span>Import</span>
<span>Risk</span> <span>Analysis</span> for <span>Animals</span> and
<span>Animal</span> <span>Products</span> <span>Volume</span> 2
<span>Quantitative</span> Risk Assessment</em>. Vol. 2. <a href="https://rr-africa.woah.org/app/uploads/2018/03/handbook_on_import_risk_analysis_-_oie_-_vol_ii.pdf" class="external-link">https://rr-africa.woah.org/app/uploads/2018/03/handbook_on_import_risk_analysis_-_oie_-_vol_ii.pdf</a>.
</div>
<div id="ref-mc2d" class="csl-entry">
Pouillot, R., and M.-L. Delignette-Muller. 2010. <span>‚ÄúEvaluating
Variability and Uncertainty in Microbial Quantitative Risk Assessment
Using Two r Packages‚Äù</span> 142: 330‚Äì40.
</div>
<div id="ref-Vose2008" class="csl-entry">
Vose, David. 2008. <em>Risk Analysis, a Quantitative Guide</em>.
Chichester, England: John Wiley &amp; Sons.
</div>
</div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Natalia Ciria.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
