<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Multivariate operations ‚Ä¢ mcmodule</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multivariate operations">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mcmodule</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mcmodule.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/multivariate_operations.html">Multivariate operations</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NataliaCiria/mcmodule/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Multivariate operations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NataliaCiria/mcmodule/blob/v1.1.0/vignettes/multivariate_operations.Rmd" class="external-link"><code>vignettes/multivariate_operations.Rmd</code></a></small>
      <div class="d-none name"><code>multivariate_operations.Rmd</code></div>
    </div>

    
    
<blockquote>
<p><em>Work in progress!</em> üèó</p>
</blockquote>
<div class="section level2">
<h2 id="sec-element-wise-operations">Element-wise operations<a class="anchor" aria-label="anchor" href="#sec-element-wise-operations"></a>
</h2>
<p>Most operations in this model are element-wise, meaning each
calculation occurs independently on matching elements across nodes.
These operations preserve node dimensions while applying functions (such
as multiplication or addition) to corresponding elements, allowing
uncertainties and variates to propagate through the calculations.</p>
<p><img src="images/mcmodule_mcnode_element-wise_operation.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
<div class="section level2">
<h2 id="sec-row-matching">Row matching<a class="anchor" aria-label="anchor" href="#sec-row-matching"></a>
</h2>
<p>Row matching operations align nodes to ensure they have compatible
dimensions and properly matched rows for element-wise calculations. This
is especially important when working with nodes containing different
scenarios. The matching process may require reordering, duplicating, or
adding rows to either or both nodes.</p>
<p>Row matching between nodes is needed in the following cases and their
combinations:</p>
<div class="section level3">
<h3 id="group-matching">Group matching<a class="anchor" aria-label="anchor" href="#group-matching"></a>
</h3>
<p>Nodes with same scenarios/dimensions but different group order</p>
<ol style="list-style-type: decimal">
<li>Check if keys that define groups are in a different order</li>
</ol>
<p><img src="images/mcmodule_group_match_1.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="2" style="list-style-type: decimal">
<li>Assign common group ids, based on keys</li>
</ol>
<p><img src="images/mcmodule_group_match_2.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="3" style="list-style-type: decimal">
<li>Reorder rows to align group ids. This is similar to dplyr
<code>left_join</code>
</li>
</ol>
<p><img src="images/mcmodule_group_match_3.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
<div class="section level3">
<h3 id="scenario-matching">Scenario matching<a class="anchor" aria-label="anchor" href="#scenario-matching"></a>
</h3>
<p>Nodes with same groups but different scenarios. The general rule for
these operations is that when no scenario is specified, it is assumed
that a variable takes the values from the baseline scenario.</p>
<ol style="list-style-type: decimal">
<li>Check if scenarios are different</li>
</ol>
<p><img src="images/mcmodule_scenario_match_1.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="2" style="list-style-type: decimal">
<li>For missing scenarios, duplicate the baseline scenario (scenario
‚Äú0‚Äù)</li>
</ol>
<p><img src="images/mcmodule_scenario_match_2.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="3" style="list-style-type: decimal">
<li>When nodes matched by scenario are used in an element-wise
operation, the resulting node will contain all scenarios from both input
nodes. This is conceptually similar to a dplyr <code>full_join</code>,
except that any unmatched rows use values from the baseline
scenario.</li>
</ol>
<p><img src="images/mcmodule_scenario_match_3.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
<div class="section level3">
<h3 id="null-matching">Null matching<a class="anchor" aria-label="anchor" href="#null-matching"></a>
</h3>
<p>When nodes contain different scenarios and groups, some groups may be
missing from certain nodes. These missing groups (called ‚Äúnull‚Äù
variates) are assigned a probability of 0. This operation typically
complements scenario matching.</p>
<ol style="list-style-type: decimal">
<li>Check for missing groups</li>
</ol>
<p><img src="images/mcmodule_null_matching_1.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol start="2" style="list-style-type: decimal">
<li>Add null variates with probability 0 for any missing groups (and
apply scenario matching)</li>
</ol>
<p><img src="images/mcmodule_null_matching_2.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
<ol style="list-style-type: decimal">
<li>When nodes are matched by scenario in an element-wise operation, the
resulting node will contain all groups from both input nodes</li>
</ol>
<p><img src="images/mcmodule_null_matching_3.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center"></p>
</div>
</div>
<div class="section level2">
<h2 id="combined-probabilities">Combined probabilities<a class="anchor" aria-label="anchor" href="#combined-probabilities"></a>
</h2>
<p>A special type of element-wise operation that automatically deals
with row matching. Combines probabilities of multiple events assuming
independence, using the formula:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>‚à™</mo><mi>B</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn><mo>‚àí</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>B</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex"> P(A \cup B) = 1 - (1-P(A))(1-P(B))</annotation></semantics></math></p>
</div>
<div class="section level2">
<h2 id="sec-row-aggregation">Row aggregation<a class="anchor" aria-label="anchor" href="#sec-row-aggregation"></a>
</h2>
<p>Row aggregation operations combine values across multiple rows
(variates) in an mcnode using specific criteria. These operations
calculate overall probabilities or sum quantities across groups.</p>
<div class="section level3">
<h3 id="probabilities">Probabilities<a class="anchor" aria-label="anchor" href="#probabilities"></a>
</h3>
<p>Some events can occur independently across multiple variates of the
same node. For example, a disease might be present in animals from
different regions or farms. To calculate the probability of an
<strong>event occurring in at least one variate</strong> within a
subset, we first group the data by aggregation keys (<em>agg_keys</em>).
Then, for each subset, we use the standard probability formula for
independent trials to find the probability of the event occurring in at
least one variate.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>_</mi><mrow><mi>a</mi><mi>g</mi><mi>g</mi></mrow><mo>=</mo><mn>1</mn><mo>‚àí</mo><munder><mo>‚àè</mo><mrow><mi>p</mi><mo>‚äÜ</mo><mi>S</mi></mrow></munder><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p\_{agg}=1-\prod_{p\subseteq S}(1-p)
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><em>S</em> represents the subset of variates included in the
aggregation</p></li>
<li><p><em>p</em> represents the probability of an event
occurring</p></li>
<li><p><em>p_agg</em> represents the probability of occurrence in at
least one variate of S</p></li>
</ul>
<div class="float">
<img src="images/mcmodule_row_aggregation_p.png" style="display: block; margin: 1em auto;width:100.0%" fig-align="center" alt="Row aggregation by pathogen. The calculation is performed element-wise across subset variates to maintain uncertainty propagation."><div class="figcaption">Row aggregation by pathogen. The calculation is
performed element-wise across subset variates to maintain uncertainty
propagation.</div>
</div>
<p>If scenarios are being simulated, scenario id must always be included
as an aggregation key, as probabilities are not calculated across
different what-if scenarios.</p>
<p>You can also keep all variariates, with their corresponding
aggregated values, to ensure dimensions compatibility in further
calculations.</p>
<div class="float">
<img src="images/mcmodule_keep_variates.png" style="display: block; margin: 1em auto;width:80.0%" fig-align="center" alt="Default row aggregation and row aggregation keeping all variates"><div class="figcaption">Default row aggregation and row aggregation
keeping all variates</div>
</div>
</div>
<div class="section level3">
<h3 id="quantities">Quantities<a class="anchor" aria-label="anchor" href="#quantities"></a>
</h3>
<p>When working with quantities (such as number of animals or farms), we
calculate totals by summing values across variates within each
subset.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>_</mi><mrow><mi>a</mi><mi>g</mi><mi>g</mi></mrow><mo>=</mo><munder><mo>‚àë</mo><mrow><mi>n</mi><mo>‚äÜ</mo><mi>S</mi></mrow></munder><mi>n</mi></mrow><annotation encoding="application/x-tex"> n\_{agg}=\sum_{n\subseteq S} n </annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><em>S</em> represents the subset of variates included in the
aggregation</p></li>
<li><p><em>n</em> represents the quantity value</p></li>
<li><p><em>n_agg</em> represents the sum of quantities across all
variates in <em>S</em></p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="trials">Trials<a class="anchor" aria-label="anchor" href="#trials"></a>
</h2>
<p>In this framework, nodes typically represent the probability of
<strong>success for a</strong> <strong>single trial with a binary
outcome</strong> (success/failure). A trial is one instance where an
event might occur, for example, an animal, farm, batch, animal movement,
or farm visit. Each trial has two possible outcomes, such as whether an
animal is infected or not, or whether a test is positive or negative. In
<strong>single-level</strong> trials, all trials are independent and
have the same probability of success<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;In this context, a ‚Äúsuccess‚Äù refers to the occurrence of
an event of interest, which may actually represent an undesirable
outcome such as the presence of a disease or a positive test result for
a pathogen.&lt;/p&gt;"><sup>1</sup></a>.</p>
<p>Some probability processes follow a hierarchical structure where
events occur at different levels. For example, when animals are
purchased from multiple farms, we must consider both the probability of
a farm being infected and the probability of an individual animal within
that farm being infected. This means infection probabilities for animals
from the same farm are not independent. In <strong>multilevel</strong>
trials, trials are organized into subsets, with each subset having its
own selection probability. A subset represents a group sharing specific
characteristics, for example, animals from the same farm or with the
same health status.</p>
<p>Most of the following probability processes and calculations are
based on Chapter 5 of the <em>Handbook on Import Risk Analysis for
Animals and Animal Products Volume 2. Quantitative risk assessment</em>
<span class="citation">(<a href="#ref-Murray2004">Murray
2004</a>)</span>.</p>
<div class="section level3">
<h3 id="single-level-trials">Single-level trials<a class="anchor" aria-label="anchor" href="#single-level-trials"></a>
</h3>
<p>In single-level trials, each trial is independent with the same
probability of success
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">trial\_p</annotation></semantics></math>).
For a set of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">trials\_n</annotation></semantics></math>
trials, the probability of at least one success is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex"> set\_p= 1-(1-trial\_p)^{trials\_n} </annotation></semantics></math></p>
<p>In <code>imports_mcmodule</code>, we have the probability that an
infected animal from an infected farm goes undetected
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>_</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">no\_detect\_a</annotation></semantics></math>).
When all animals (in a variate) have the same probability, we can use
the total number of animals selected per farm
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">animals\_n</annotation></semantics></math>)
as the number of trials (<code>trials_n</code>) to determine the
probability that at least one infected animal from one farm is not
detected
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>_</mi><mi>s</mi><mi>e</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">no\_detect\_set</annotation></semantics></math>).
Note that while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">animals\_n</annotation></semantics></math>
isn‚Äôt defined as an mcnode in <code>imports_mcmodule</code> (not used in
<code>imports_mcmodule$model_exp</code>), it can be automatically
generated in <code><a href="../reference/trial_totals.html">trial_totals()</a></code> because it‚Äôs included in
<code>imports_mctable</code> and the required data exists in
<code>imports_mcmodule$data</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Single-level trial</span></span>
<span><span class="va">imports_mcmodule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_totals.html">trial_totals</a></span><span class="op">(</span></span>
<span>  mcmodule <span class="op">=</span> <span class="va">imports_mcmodule</span>,</span>
<span>  mc_names <span class="op">=</span> <span class="st">"no_detect_a"</span>, <span class="co"># trial_p</span></span>
<span>  trials_n <span class="op">=</span> <span class="st">"animals_n"</span>,</span>
<span>  mctable <span class="op">=</span> <span class="va">imports_mctable</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Probability that at least one infected animal from an infected farm is not detected</span></span>
<span><span class="fu"><a href="../reference/mc_summary.html">mc_summary</a></span><span class="op">(</span><span class="va">imports_mcmodule</span>,<span class="st">"no_detect_a_set"</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;   pathogen origin      mean           sd       Min      2.5%       25%</span></span>
<span><span class="co">#&gt; 1        a   nord 0.9999344 7.271373e-05 0.9994190 0.9997340 0.9999148</span></span>
<span><span class="co">#&gt; 2        a  south 0.9999945 9.174980e-06 0.9998817 0.9999651 0.9999936</span></span>
<span><span class="co">#&gt; 3        a   east 1.0000000 3.759259e-10 1.0000000 1.0000000 1.0000000</span></span>
<span><span class="co">#&gt; 4        b   nord 0.9994337 7.901747e-04 0.9939744 0.9970818 0.9993747</span></span>
<span><span class="co">#&gt; 5        b  south 1.0000000 4.055315e-14 1.0000000 1.0000000 1.0000000</span></span>
<span><span class="co">#&gt; 6        b   east 1.0000000 0.000000e+00 1.0000000 1.0000000 1.0000000</span></span>
<span><span class="co">#&gt;         50%       75%     97.5%       Max  nsv Na's</span></span>
<span><span class="co">#&gt; 1 0.9999601 0.9999825 0.9999952 0.9999982 1001    0</span></span>
<span><span class="co">#&gt; 2 0.9999979 0.9999993 0.9999999 1.0000000 1001    0</span></span>
<span><span class="co">#&gt; 3 1.0000000 1.0000000 1.0000000 1.0000000 1001    0</span></span>
<span><span class="co">#&gt; 4 0.9997226 0.9998992 0.9999833 0.9999951 1001    0</span></span>
<span><span class="co">#&gt; 5 1.0000000 1.0000000 1.0000000 1.0000000 1001    0</span></span>
<span><span class="co">#&gt; 6 1.0000000 1.0000000 1.0000000 1.0000000 1001    0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multilevel-trials">Multilevel trials<a class="anchor" aria-label="anchor" href="#multilevel-trials"></a>
</h3>
</div>
<div class="section level3">
<h3 id="simple-multilevel">Simple multilevel<a class="anchor" aria-label="anchor" href="#simple-multilevel"></a>
</h3>
<p>In multilevel trials, we account for hierarchical structures where
trials are organized into subsets. For example, when considering animals
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">trials\_n</annotation></semantics></math>)
from different farms
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">subset\_n</annotation></semantics></math>),
we must account for both the farm‚Äôs selection probability
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">subset\_p</annotation></semantics></math>)
and the individual animal‚Äôs probability of success
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">trial\_p</annotation></semantics></math>).</p>
<p>The probability of at least one success in this hierarchical
structure is given by:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>‚ãÖ</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>n</mi></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex"> set\_p= 1-(1-subset\_p \cdot (1-(1-trial\_p)^{trial\_n}))^{subset\_n}  </annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><em>trials_p</em> represents the probability of a trial in a
subset being a success</p></li>
<li><p><em>trials_n</em> represents the number of trials in
subset</p></li>
<li><p><em>subset_p</em> represents the probability of a subset being
selected</p></li>
<li><p><em>subset_n</em> represents the number of subsets</p></li>
<li><p><em>set_p</em> represents the probability of a at least one trial
of at least one subsetbeing a success</p></li>
</ul>
<p>When considering animals (<code>trials_n</code>) from different farms
(<code>subset_n</code>, we must account for both the farm‚Äôs probability
of being infected (<code>subsets_p</code>) and the individual animal‚Äôs
probability of being infected (<code>trial_p</code>).</p>
<p><img src="images/mcmodule_multilevel_trial_drawing.png"></p>
<p><img src="images/mcmodule_multilevel_trial_diagram.png"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simple multilevel trial</span></span>
<span><span class="va">imports_mcmodule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_totals.html">trial_totals</a></span><span class="op">(</span></span>
<span>  mcmodule <span class="op">=</span> <span class="va">imports_mcmodule</span>,</span>
<span>  mc_names <span class="op">=</span> <span class="st">"no_detect_a"</span>, <span class="co"># trial_p</span></span>
<span>  trials_n <span class="op">=</span> <span class="st">"animals_n"</span>,</span>
<span>  subsets_n <span class="op">=</span> <span class="st">"farms_n"</span>,</span>
<span>  subsets_p <span class="op">=</span> <span class="st">"h_prev"</span>,</span>
<span>  mctable <span class="op">=</span> <span class="va">imports_mctable</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Probability that at least one infected animal from at least one farm is not detected</span></span>
<span><span class="fu"><a href="../reference/mc_summary.html">mc_summary</a></span><span class="op">(</span><span class="va">imports_mcmodule</span>,<span class="st">"no_detect_a_set"</span>, digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;   pathogen origin mean     sd  Min 2.5%  25%  50%  75% 97.5%  Max  nsv Na's</span></span>
<span><span class="co">#&gt; 1        a   nord 0.38 0.0200 0.34 0.34 0.36 0.38 0.39  0.41 0.41 1001    0</span></span>
<span><span class="co">#&gt; 2        a  south 0.30 0.0600 0.18 0.19 0.24 0.30 0.36  0.40 0.40 1001    0</span></span>
<span><span class="co">#&gt; 3        a   east 0.60 0.0400 0.52 0.53 0.57 0.60 0.64  0.67 0.68 1001    0</span></span>
<span><span class="co">#&gt; 4        b   nord 0.99 0.0081 0.97 0.97 0.98 0.99 0.99  1.00 1.00 1001    0</span></span>
<span><span class="co">#&gt; 5        b  south 0.96 0.0081 0.94 0.94 0.95 0.96 0.97  0.97 0.97 1001    0</span></span>
<span><span class="co">#&gt; 6        b   east 0.97 0.0200 0.92 0.92 0.95 0.97 0.98  0.99 0.99 1001    0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multiple-group-multilevel-trials">Multiple group multilevel trials<a class="anchor" aria-label="anchor" href="#multiple-group-multilevel-trials"></a>
</h3>
<p>In multiple group multilevel trials, several variates (groups) can
belong to the same subset. For example, when selecting animals of
different categories (cow, calf, heifer, bull) from the same farm, their
infection probabilities are not independent. You should include
aggregation keys for groups that are not independent to calculate their
trial probabilities, for example, aggregating variates for different
animal categories by farm. For this calculation, the subset_p and
subset_n values must be identical across all variates being
aggregated.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mi>_</mi><mi>a</mi><mi>g</mi><mi>g</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><munder><mo>‚àè</mo><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo>‚äÜ</mo><mi>S</mi></mrow></munder><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">
trial\_p\_agg=1-\prod_{trial\_p\subseteq S}(1-trial\_p)^{trial\_n}
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mi>_</mi><mi>a</mi><mi>g</mi><mi>g</mi><mo>=</mo><mn>1</mn><mo>‚àí</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>p</mi><mo>‚ãÖ</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>_</mi><mi>p</mi><mi>_</mi><mi>a</mi><mi>g</mi><mi>g</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>_</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex"> set\_p\_agg = 1-(1-subset\_p \cdot trial\_p\_agg)^{subset\_n}  </annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p>S represents the variates included in the aggregation</p></li>
<li><p><em>trials_p</em> represents the probability of success of a
trial in a subset</p></li>
<li><p><em>trials_n</em> represents the number of trials in
subset</p></li>
<li><p><em>trials_p</em> <em>_agg</em> represents the probability of
success of at least one variate in at least one of the aggregated
variates</p></li>
<li><p><em>subset_p</em> represents the probability of a subset being
selected</p></li>
<li><p><em>subset_n</em> represents the number of subsets</p></li>
<li><p><em>set_p_agg</em> represents the probability of success of a at
least one trial in at least one of the aggregated variates in at least
one subset</p></li>
</ul>
<p>As with row aggregation, you can keep all variates to maintain
dimensions compatibility in further calculations.</p>
<p><img src="images/mcmodule_multilevel_trial_drawing_groups.png"></p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Murray2004" class="csl-entry">
Murray, Noel. 2004. <em>Handbook on <span>Import</span>
<span>Risk</span> <span>Analysis</span> for <span>Animals</span> and
<span>Animal</span> <span>Products</span> <span>Volume</span> 2
<span>Quantitative</span> Risk Assessment</em>. Vol. 2. <a href="https://rr-africa.woah.org/app/uploads/2018/03/handbook_on_import_risk_analysis_-_oie_-_vol_ii.pdf" class="external-link">https://rr-africa.woah.org/app/uploads/2018/03/handbook_on_import_risk_analysis_-_oie_-_vol_ii.pdf</a>.
</div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Natalia Ciria.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
